# generated: 2026-01-02
# System Auto: last updated on: 2026-01-02T20:15:36
# Section 18: Portable Plugin Specification

Generated: 2026-01-02 (Session 156)
Purpose: Define manifest.yaml schema and LLM-agnostic installation mechanism
Status: DESIGN
Resolves: G6 (Portable Plugin Structure)

---

## Overview

HAIOS is designed as a **portable plugin** that can be installed on any LLM CLI interface. This section specifies:
- Plugin manifest schema (manifest.yaml)
- Directory structure
- Installation mechanism
- Versioning strategy
- LLM-agnostic design principles

---

## Design Principles

### 1. LLM-Agnostic Core
The plugin source (`.claude/haios/`) contains no LLM-specific syntax. All LLM-specific formats are generated by the installer.

### 2. Push Model
Plugin "installs" by pushing/generating to the target LLM's native format:
- Claude CLI: `.claude/commands/`, `.claude/skills/`, `.claude/agents/`
- Future: `.gemini/commands/`, `.cursor/commands/`, etc.

### 3. Separation of Source and Generated
- **Source:** `.claude/haios/` - version-controlled, portable
- **Generated:** `.claude/commands/`, etc. - can be regenerated, LLM-specific

### 4. Manifest as Contract
`manifest.yaml` declares what the plugin provides. Installer uses this to generate appropriate outputs.

---

## Directory Structure

```
.claude/haios/                     ← PLUGIN ROOT (LLM-agnostic)
├── manifest.yaml                  ← Plugin metadata + component declarations
├── config/                        ← Configuration files
│   ├── cycle-definitions.yaml
│   ├── gates.yaml
│   ├── skill-manifest.yaml
│   ├── agent-manifest.yaml
│   ├── hook-handlers.yaml
│   ├── node-bindings.yaml
│   ├── thresholds.yaml
│   ├── events.yaml
│   └── error-types.yaml
├── manifesto/                     ← L0-L4 immutable context
│   ├── L0-telos.md
│   ├── L1-principal.md
│   ├── L2-intent.md
│   └── L3-requirements.md
├── skills/                        ← Skill definitions (LLM-agnostic prompts)
│   ├── implementation-cycle/
│   │   ├── skill.yaml             ← Metadata
│   │   └── prompt.md              ← Prompt template
│   └── ...
├── agents/                        ← Agent definitions
│   ├── preflight-checker/
│   │   ├── agent.yaml             ← Metadata
│   │   └── prompt.md              ← System prompt
│   └── ...
├── commands/                      ← Command definitions
│   ├── coldstart/
│   │   ├── command.yaml           ← Metadata
│   │   └── prompt.md              ← Command prompt
│   └── ...
└── hooks/                         ← Hook handlers (code, not prompts)
    └── handlers/
        ├── pre_tool_use.py
        ├── post_tool_use.py
        └── ...
```

---

## 18.1 manifest.yaml Schema

```yaml
# .claude/haios/manifest.yaml
# Plugin manifest - declares everything HAIOS provides

# Plugin metadata
plugin:
  name: "haios"
  version: "2.0.0"
  description: "Hybrid AI Operating System - Trust Engine for AI agents"
  author: "Ruben Perez"
  license: "Proprietary"
  min_cli_version: "1.0.0"

# Target LLM declarations
targets:
  - id: "claude"
    name: "Claude CLI"
    version: ">=1.0.0"
    output_path: ".claude/"
  # Future targets:
  # - id: "gemini"
  #   name: "Gemini CLI"
  #   output_path: ".gemini/"

# Component declarations
components:
  # Skills provided by this plugin
  skills:
    - id: "implementation-cycle"
      source: "skills/implementation-cycle/"
      category: "cycle"
      generates:
        - type: "skill_directory"
          path: "{target_output}/skills/implementation-cycle/"

    - id: "investigation-cycle"
      source: "skills/investigation-cycle/"
      category: "cycle"
      generates:
        - type: "skill_directory"
          path: "{target_output}/skills/investigation-cycle/"

    # ... (15 skills total)

  # Agents provided by this plugin
  agents:
    - id: "preflight-checker"
      source: "agents/preflight-checker/"
      required: true
      generates:
        - type: "agent_file"
          path: "{target_output}/agents/preflight-checker.md"

    - id: "schema-verifier"
      source: "agents/schema-verifier/"
      required: true
      generates:
        - type: "agent_file"
          path: "{target_output}/agents/schema-verifier.md"

    # ... (7 agents total)

  # Commands provided by this plugin
  commands:
    - id: "coldstart"
      source: "commands/coldstart/"
      generates:
        - type: "command_file"
          path: "{target_output}/commands/coldstart.md"

    - id: "new-work"
      source: "commands/new-work/"
      generates:
        - type: "command_file"
          path: "{target_output}/commands/new-work.md"

    # ... (18 commands total)

  # Hooks provided by this plugin
  hooks:
    - event: "PreToolUse"
      handler: "hooks/handlers/pre_tool_use.py"
      generates:
        - type: "settings_entry"
          path: "{target_output}/settings.local.json"

    - event: "PostToolUse"
      handler: "hooks/handlers/post_tool_use.py"
      generates:
        - type: "settings_entry"
          path: "{target_output}/settings.local.json"

    - event: "UserPromptSubmit"
      handler: "hooks/handlers/user_prompt_submit.py"
      generates:
        - type: "settings_entry"
          path: "{target_output}/settings.local.json"

    - event: "Stop"
      handler: "hooks/handlers/stop.py"
      generates:
        - type: "settings_entry"
          path: "{target_output}/settings.local.json"

  # Configuration files
  config:
    - source: "config/"
      generates:
        - type: "copy"
          path: "{target_output}/haios/config/"

  # Context files
  context:
    - source: "manifesto/"
      generates:
        - type: "copy"
          path: "{target_output}/haios/manifesto/"

# Dependencies (external tools required)
dependencies:
  mcp_servers:
    - name: "haios-memory"
      required: true
      config_path: ".mcp.json"

    - name: "context7"
      required: false
      config_path: ".mcp.json"

  python:
    version: ">=3.10"
    packages:
      - "ruamel.yaml>=0.17"
      - "litellm>=1.0"

# Installation hooks
install:
  pre_install:
    - command: "python -m haios_etl.cli validate-schema"
      description: "Validate plugin schema"

  post_install:
    - command: "python -c 'from haios_etl.cli import update_status; update_status()'"
      description: "Generate initial status"

# Versioning strategy
versioning:
  strategy: "semver"
  changelog: "CHANGELOG.md"
  migration_scripts: "migrations/"
```

---

## 18.2 Installation Mechanism

### Install Command

```bash
# Future: Plugin installation command
haios install .claude/haios/

# Or via just recipe
just haios-install
```

### Installation Flow

```
1. READ manifest.yaml
    │
    ▼
2. VALIDATE dependencies (Python, MCP servers)
    │
    ▼
3. RUN pre_install hooks
    │
    ▼
4. FOR EACH component:
    │
    ├── Parse source
    ├── Transform to target format
    └── Write to output path
    │
    ▼
5. UPDATE settings.local.json with hook entries
    │
    ▼
6. RUN post_install hooks
    │
    ▼
7. EMIT InstallCompleted event
```

### Installer Output

```
[HAIOS Install] Starting...
[HAIOS Install] Validating dependencies...
  ✓ Python 3.10+
  ✓ MCP server: haios-memory
  ✓ MCP server: context7 (optional)
[HAIOS Install] Generating components...
  ✓ 15 skills → .claude/skills/
  ✓ 7 agents → .claude/agents/
  ✓ 18 commands → .claude/commands/
  ✓ 4 hook handlers → .claude/settings.local.json
  ✓ Config files → .claude/haios/config/
[HAIOS Install] Running post-install...
  ✓ Status generated
[HAIOS Install] Complete! Version 2.0.0 installed.
```

---

## 18.3 LLM Target Transformation

Each LLM has different native formats. The installer transforms plugin source to target format.

### Claude CLI Target

| Component | Source Format | Target Format |
|-----------|--------------|---------------|
| Skill | `skill.yaml` + `prompt.md` | `SKILL.md` with frontmatter |
| Agent | `agent.yaml` + `prompt.md` | `<name>.md` with frontmatter |
| Command | `command.yaml` + `prompt.md` | `<name>.md` with frontmatter |
| Hook | Python file | `settings.local.json` entry |

### Transformation Example

**Source:** `.claude/haios/skills/implementation-cycle/skill.yaml`
```yaml
id: implementation-cycle
name: Implementation Cycle
description: PLAN-DO-CHECK-DONE workflow with MUST gates
category: cycle
phases: [PLAN, DO, CHECK, DONE, CHAIN]
node_binding: implement
```

**Source:** `.claude/haios/skills/implementation-cycle/prompt.md`
```markdown
# Implementation Cycle

You are entering the implementation cycle...
```

**Target:** `.claude/skills/implementation-cycle/SKILL.md`
```markdown
---
name: implementation-cycle
description: PLAN-DO-CHECK-DONE workflow with MUST gates
generated: 2026-01-02
last_updated: 2026-01-02T20:35:00
---
# Implementation Cycle

You are entering the implementation cycle...
```

---

## 18.4 Versioning Strategy

### Semantic Versioning

```
MAJOR.MINOR.PATCH

MAJOR: Breaking changes (manifest schema, hook API)
MINOR: New features (new skills, new agents)
PATCH: Bug fixes (prompt improvements, typos)
```

### Migration Scripts

For major version upgrades, migration scripts handle transformations:

```
.claude/haios/migrations/
├── 1.x-to-2.0.py    # Migration from 1.x to 2.0
└── 2.0-to-2.1.py    # Migration from 2.0 to 2.1
```

### Version Lock

`.claude/haios/version.lock` tracks installed version:
```yaml
installed_version: "2.0.0"
installed_at: "2026-01-02T20:35:00"
components_hash: "abc123..."
```

---

## 18.5 What "LLM-Agnostic" Means

### Principles

1. **No LLM-specific syntax in source**
   - Prompts use generic markdown
   - No Claude-specific XML, no Gemini-specific tags

2. **Tool references are generic**
   - `{tool:Read}` instead of `Read` tool directly
   - Installer maps to target tool names

3. **Frontmatter is transformed**
   - Source has generic YAML
   - Installer adds LLM-specific fields

### What's NOT Portable

Some aspects are inherently LLM-specific:
- Hook dispatcher code (different APIs per CLI)
- MCP server integration (different protocols)
- Tool permissions (different security models)

These are in `hooks/handlers/` and must be reimplemented per target.

---

## Gap Resolution

**G6 Status:** DESIGNED

Portable plugin specification complete:
- [x] manifest.yaml schema with components, targets, dependencies
- [x] Directory structure for LLM-agnostic source
- [x] Installation mechanism with pre/post hooks
- [x] LLM target transformation rules
- [x] Versioning strategy (semver + migrations)
- [x] LLM-agnostic design principles defined

---

*Created Session 156*
